{"version":3,"file":"index.js","sources":["../src/connectionState.ts"],"sourcesContent":["import { listenable } from 'custom-listenable'\n\nexport type ConnectionState = 'online' | 'offline'\nexport type ConnectionOptions = {\n\tendpoints?: string[]\n\tinitialState?: ConnectionState\n\tretryInterval?: number\n}\n\nexport const connectionState = (options: ConnectionOptions = {}) => {\n\tconst listener = listenable<ConnectionState>()\n\tconst {\n\t\tendpoints = [],\n\t\tinitialState = 'online',\n\t\tretryInterval = 5000,\n\t} = options\n\tlet endpointsCheckCounter = 0\n\tlet endpointsCheckTimer: ReturnType<typeof setTimeout> | null = null\n\tlet lastState: ConnectionState = initialState\n\n\tconst areEndpointsReachable = async () => {\n\t\tconst results = await Promise.all(\n\t\t\tendpoints.map(async (endpoint) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst response = await fetch(endpoint, {\n\t\t\t\t\t\tmethod: 'HEAD',\n\t\t\t\t\t\tmode: 'no-cors',\n\t\t\t\t\t})\n\t\t\t\t\treturn response.ok || response.type === 'opaque'\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t\treturn results.every((result) => result)\n\t}\n\n\tconst startEndpointsCheck = () => {\n\t\tif (endpointsCheckTimer !== null) {\n\t\t\treturn\n\t\t}\n\t\tendpointsCheckLoop()\n\t}\n\n\t// @TODO: Rerun as soon as possible if window visibility changes to visible and focus acquired\n\t// @TODO: Don't check without listeners\n\tconst endpointsCheckLoop = () => {\n\t\tendpointsCheckTimer = setTimeout(\n\t\t\tasync () => {\n\t\t\t\tconst reachable = await areEndpointsReachable()\n\t\t\t\tif (reachable) {\n\t\t\t\t\tif (lastState === 'offline') {\n\t\t\t\t\t\tlastState = 'online'\n\t\t\t\t\t\temitState()\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (lastState === 'online') {\n\t\t\t\t\t\tlastState = 'offline'\n\t\t\t\t\t\temitState()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tendpointsCheckLoop()\n\t\t\t},\n\t\t\tendpointsCheckCounter === 0 ? 0 : retryInterval,\n\t\t)\n\t\tendpointsCheckCounter++\n\t}\n\n\tconst stopEndpointsCheck = () => {\n\t\tif (endpointsCheckTimer) {\n\t\t\tclearTimeout(endpointsCheckTimer)\n\t\t\tendpointsCheckTimer = null\n\t\t\tendpointsCheckCounter = 0\n\t\t}\n\t}\n\n\tconst getState = () => lastState\n\tconst getNewState = () => (navigator.onLine ? 'online' : 'offline')\n\n\tconst handleNewState = (newState: ConnectionState) => {\n\t\tif (newState === 'offline') {\n\t\t\tlastState = newState\n\t\t\tstopEndpointsCheck()\n\t\t\temitState()\n\t\t} else if (newState === 'online') {\n\t\t\tstartEndpointsCheck()\n\t\t}\n\t}\n\n\tconst handleStateChange = () => {\n\t\tconst newState = getNewState()\n\n\t\tif (newState !== lastState) {\n\t\t\thandleNewState(newState)\n\t\t}\n\t}\n\n\tconst emitState = () => {\n\t\tlistener.emit(getState())\n\t}\n\n\tif ('addEventListener' in globalThis) {\n\t\tglobalThis.addEventListener('offline', handleStateChange)\n\t\tglobalThis.addEventListener('online', handleStateChange)\n\t\thandleNewState(getNewState())\n\t}\n\n\treturn {\n\t\taddListener: listener.addListener,\n\t\tremoveListener: listener.removeListener,\n\t\tgetState,\n\t}\n}\n"],"names":["listenable"],"mappings":"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"}